<!DOCTYPE html>
<html>
<head>
<title>Facial expression similarity experiment</title>
<script src="jsPsych/jspsych.js"></script>
<script src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
<script src="jsPsych/plugins/jspsych-image-slider-response_noButton.js"></script>
<script src="jsPsych/plugins/jspsych-instructions.js"></script>
<script src="jsPsych/plugins/jspsych-survey-text.js"></script>

<script src="jquery-3.3.1.min.js"></script>

<script src="sequential_faster_loading_funcs.js"></script>

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.713.0.min.js"></script>
<link	href="jsPsych/css/jspsych.css"	rel="stylesheet" type="text/css">
<style>

body{
	background-color: #AAAAAA;
}

.jspsych-instructions-nav { margin-bottom: 100px; }
#consentDiv { font-size: 9pt; text-align: justify; }

.Happy {
	display: inline-block;
	width: 70.5px;
	height: 90.5px;
	background-size: 5000% 800%;
	background-image: url('Happy.jpg');
	padding: 30px;
}

div.preload {
    display: none;
}

</style>
</head>
<body>
	
	<div class="preload">
		<img src="Happy.jpg" />
		<img src="Angry.jpg" />
		
	</div>

<script>
/* Require a new-ish browser:
------------------------------------------ */
function supportsLiterals() {
  try { return eval("''===``") }
  catch(e) { return false; }
}
if (!supportsLiterals()) {
	var txt = "Sorry, this experiment requires a newer browser, so yours is not able to be used. The latest Chrome, Firefox, Safari or Edge all work.";
	alert(txt);
	document.body.onload = function() { document.body.innerHTML = txt; };
}

/* Variables
------------------------------------------ */

var faceData = {}; //create a data dictionary that will capture all of the data

/* Instructions
------------------------------------------ */
var trialList = [];
var total_trials = 50;

var trialCount = 0;
function updateCounter() {
	trialCount = trialCount+1;
	jsPsych.setProgressBar(trialCount/264);
}

trialList.push({
	type: "instructions",
	pages: ['placeholder instructions here, please ignore for now'],  
	show_clickable_nav: true
})

// trialList.push({
//     type: 'survey-text',
//     questions: [{prompt: "Please enter your Prolific ID (this will be used for validation purposes)"}],
//     on_finish: function(data){
//       faceData.subject_id = JSON.parse(data.responses).Q0; // save id as global variable
//       jsPsych.data.addProperties({participant_id: faceData.subject_id});} // add the participant column to all current and future data entries
// })


var person = ["HappyA", "AngryA", "HappyB", "AngryB","HappyC", "AngryC", "HappyD","AngryD"]
var emotion_value = [...Array(50).keys()].map(function(item) { 
    return item + 1; 
});

for (i = 0; i < (total_trials+1); i++) {
	faceData.sequence_length = getRandomInt(1,12);
	faceData.face = getRandomElement(person);
	faceData.person = faceData.face[5]
	faceData.emotion_values = getRandom(emotion_value, faceData.sequence_length);
	faceData.valence = faceData.face.slice(0,5);

		for (j = 0; j < (faceData.sequence_length+1); j++) {

			faceData.intensity = faceData.emotion_values[j];
			faceData.fixation_time = getFixationTime


			trialList.push({
				type: 'html-keyboard-response',
				choices: jsPsych.NO_KEYS, 
				stimulus: '<p style="font-size: 48px;">+</p>',
				trial_duration:  faceData.fixation_time,  
				data: {
					Name:'fixation'},
				response_ends_trial: false,
			});

			trialList.push({
				type: 'html-keyboard-response',
				choices: jsPsych.NO_KEYS, 
				stimulus: "<div class='Happy' style='background-position:" + (faceData.intensity*100) + "% 0%'></div>",
				trial_duration: 150000,
				data: { 
					emotional_intensity: faceData.intensity ,
					person: faceData.person,
					sequence_length: faceData.sequence_length,
					valence: faceData.valence,
					fixation_time: faceData.fixation_time
					
				},
				response_ends_trial: false,
				on_finish: function(){
					if (trialCount % 10 == 0) saveDataToS3();
				}
			});
		}

		trialList.push({ //participants see a slider and asked to estimate the mean group emotion
			type: 'image-slider-response_noButton',
			stimulus: getScale,
			prompt: "<p>Estimate the average emotion of the sequence you just viewed</p>",
			step:1,
			max:50,
			start: 0,
			on_load: morphedScale,
			on_finish: function(){
				updateCounter()},
			data:  //we save all the data here to make it easy to analyze and process the data.
				{trialCount: trialCount,
				Name: 'response',
				fixationTime: 0, //change
				//faceIdentity: faceData.person,
				description: 0, //change
				emotional_intensity: faceData.intensity ,
				person: faceData.person,
				sequence_length: faceData.sequence_length,
				valence: faceData.valence
				
			}
		});

}


trialList.push({
	type: 'survey-text',
	preamble: "Thank you! You're done. If you would, please tell us about yourself:",
	questions: [
		{prompt: "How old are you?", name: 'age', rows: 1, columns: 5},
		{prompt: "Gender:", name: 'gender', rows: 1, columns: 5},
		{prompt: "Any comments? Loved it? Hated it? Anything else?", name: 'comments', rows: 3, columns: 40}
	],
	button_label: "Submit",
	on_finish: function(){
		saveDataToS3()
	}
});



trialList.push({
	type: "instructions",
	pages: ["You're done! Please click the 'next' to return to Prolific!"],
	show_clickable_nav: true,
	on_start:function(){
		saveDataToS3()
	}
})



jsPsych.init({
	timeline: trialList,
	show_progress_bar: true,
	show_preload_progress_bar: true,
	auto_update_progress_bar: false,
	message_progress_bar: "Progress on entire study:",
	use_webaudio: false,
	experiment_width: 750,
	default_iti: 200,
	exclusions: {
		min_width: 700,
		min_height: 500
	},
	on_close: function(){
		saveDataToS3()
	},
	on_finish: function(){
		saveDataToS3();
		window.location = "https://app.prolific.co/submissions/complete?cc=4D8B99B1" //survey link art winter 2021
	}

});


</script>
</body>
</html>
